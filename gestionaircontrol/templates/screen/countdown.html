{% load staticfiles i18n %}<!DOCTYPE html>
<html>
  <head lang="en">
    <meta charset="UTF-8">
    <title>CountDown SCREEN</title>
    <style>
      * {
          box-sizing: border-box;
        }
        html, body{
          height: 100%;
          overflow: hidden;
        }
  			body{
  				background-color: black;
          display: -webkit-flex;
  				display: flex;
          -webkit-flex-flow: column;
  				flex-flow: column;
          -webkit-justify-content: center;
  				justify-content: center;
          -webkit-align-items: center;
  				align-items: center;
  			}
  			.exit{
  				background-color: #14A149;

  			}
        .coutdown{
           background-color: black;
        }
        .welcome{
          background: #0098D8 url('/static/images/background.png') no-repeat 50% 50%;
          -webkit-background-size:contain;
          background-size: contain;
        }
  			.exit #exit-block{
  				display: block;
  			}
  			#exit-block{
  				display: none;
  			}

        .number{
          color:#c00;
          margin: 0;
          font-size: 700px;
          font-family: monospace;
          font-weight: bold;
          display: none;
        }

        .clock {
          -webkit-flex-flow: row;
         flex-flow: row;
         -webkit-transform: scale(2.8);
         transform: scale(2.8);
         display: none;
        }
        .countdown > .clock{
          display: -webkit-flex;
          display: flex;
        }
        .digit {
          width:120px;
          height:200px;
          margin:0 5px;
          position:relative;
        }

        .digit .segment {
          background:#c00;
          border-radius:5px;
          position:absolute;
          opacity:0.15;
          transition:opacity 0.2s;
          -webkit-transition:opacity 0.2s;
          -ms-transition:opacity 0.2s;
          -moz-transition:opacity 0.2s;
          -o-transition:opacity 0.2s;
        }

        .digit .segment.on, .separator {
          opacity:1;
          box-shadow:0 0 50px rgba(255,0,0,0.7);
          transition:opacity 0s;
          -webkit-transition:opacity 0s;
          -ms-transition:opacity 0s;
          -moz-transition:opacity 0s;
          -o-transition:opacity 0s;
        }

        .separator-container{
          display: -webkit-flex;
          display: flex;
          -webkit-flex-flow: column;
          flex-flow: column;
          -webkit-justify-content: center;
          justify-content: center;

        }

        .separator {
          width:20px;
          height:20px;
          background:#c00;
          border-radius:50%;
          display:inline-block;
          margin: 13px 0;
        }

        .digit .segment:nth-child(1) {
          top:10px;
          left:20px;
          right:20px;
          height:10px;
        }

        .digit .segment:nth-child(2) {
          top:20px;
          right:10px;
          width:10px;
          height:75px;
          height:calc(50% - 25px);
        }

        .digit .segment:nth-child(3) {
          bottom:20px;
          right:10px;
          width:10px;
          height:75px;
          height:calc(50% - 25px);
        }

        .digit .segment:nth-child(4) {
          bottom:10px;
          right:20px;
          height:10px;
          left:20px;
        }

        .digit .segment:nth-child(5) {
          bottom:20px;
          left:10px;
          width:10px;
          height:75px;
          height:calc(50% - 25px);
        }

        .digit .segment:nth-child(6) {
          top:20px;
          left:10px;
          width:10px;
          height:75px;
          height:calc(50% - 25px);
        }

        .digit .segment:nth-child(7) {
          bottom:95px;
          bottom:calc(50% - 5px);
          right:20px;
          left:20px;
          height:10px;
        }
    </style>
  </head>

  <body>
    <div id="exit-block">
      <img src="/static/images/exit.gif" />
    </div>
    <h1 id="three" class="number">3</h1>
    <h1 id="two" class="number">2</h1>
    <h1 id="one" class="number">1</h1>
    <div class="clock">
      <div class="digit minutes">
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
      </div>
      <div class="digit minutes">
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
      </div>
      <div class="separator-container">
        <div class="separator"></div>
        <div class="separator"></div>
      </div>
      <div class="digit seconds">
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
      </div>
      <div class="digit seconds">
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
        <div class="segment"></div>
      </div>
    </div>
    <script src="{% static 'vendor/jquery/jquery-2.1.4.min.js' %}"></script>
    <script>
      $(document).ready(function(){

              var gameData = {};
              var endDateSeconds = new Date().getTime();

              var digitSegments = [
                [1,2,3,4,5,6],
                [2,3],
                [1,2,7,5,4],
                [1,2,7,3,4],
                [6,7,2,3],
                [1,6,7,3,4],
                [1,6,5,4,3,7],
                [1,2,3],
                [1,2,3,4,5,6,7],
                [1,2,7,3,6]
            ];


            var _minutes = document.querySelectorAll('.minutes');
            var _seconds = document.querySelectorAll('.seconds');

            var setNumber = function(digit, number, on) {
                var segments = digit.querySelectorAll('.segment');
                var current = parseInt(digit.getAttribute('data-value'));

                // only switch if number has changed or wasn't set
                if (!isNaN(current) && current != number) {
                  // unset previous number
                  digitSegments[current].forEach(function(digitSegment, index) {

                      segments[digitSegment-1].classList.remove('on');

                  });
                }

                if (isNaN(current) || current != number) {
                  // set new number after
                  setTimeout(function() {
                    digitSegments[number].forEach(function(digitSegment, index) {

                        segments[digitSegment-1].classList.add('on');

                    });
                  }, 30);
                  digit.setAttribute('data-value', number);
                }
              };



      				function startGame(){
                //display welcome
                showWelcome()
                //after x
                setTimeout(start321, (gameData.intro_duration - 3)*1000);
      				}

              function showWelcome(){
                $('body').removeClass('exit');
                $('body').removeClass('countdown');
                $('body').addClass('welcome');
              }

              var $three = $('#three');
              var $two = $('#two');
              var $one = $('#one');

      		function start321(){
          		$('body').removeClass('welcome');
                    $three.fadeIn(1000, function(){
                       $three.hide();
                       $two.fadeIn(1000, function(){
                         $two.hide();
                         $one.fadeIn(1000, function(){
                           $one.hide();
                           startCountDown();
                         })
                       })
                    })
      		}
      		var coutdownInterval;

              function updateDigits() {
                  var countDownSeconds = Math.round((endDateSeconds - new Date().getTime()) / 1000);
                  var minutes = Math.max((countDownSeconds - (countDownSeconds % 60))/60, 0);
                  var seconds = Math.max(countDownSeconds % 60, 0);

                  setNumber(_minutes[0], Math.floor(minutes/10), 1);
                  setNumber(_minutes[1], minutes%10, 1);

                  setNumber(_seconds[0], Math.floor(seconds/10), 1);
                  setNumber(_seconds[1], seconds%10, 1);
                }

      		function startCountDown(){
              $('body').addClass('countdown');
               clearInterval(coutdownInterval);

      		     coutdownInterval = setInterval(updateDigits, 1000);
               updateDigits();
      		}

          function handleIntro(data){
              gameData = data;
              endDateSeconds = new Date(gameData.game_start_time).getTime() + (gameData.game_duration + gameData.intro_duration) * 1000;
              startGame();
          }

          var currentState = 'welcome';
          function loop(){
                //pool for information
                $.get('/screen/countdown/json/', function(data){
                    if(currentState !== data.game_status){
                      currentState = data.game_status;
                      if(currentState === 'POWERDOWN' || currentState === 'STOP'){
                        showExit();
                      }
                      if(currentState === 'INTRO'){
                        handleIntro(data);
                      }
                    }
                });
                setTimeout(loop, 1000);
          }
          showWelcome();
          if(window.location.hash === '#sim'){
              handleIntro({game_status: 'INTRO', game_start_time: new Date().toISOString(), game_duration: 15, intro_duration: 10});
              setTimeout(showExit, 26000);
          }else{
              loop();
          }
      	});
    </script>
  </body>
</html>
